FROM golang:1.25.4-trixie@sha256:27e1c927a07ed2c7295d39941d6d881424739dbde9ae3055d0d3013699ed35e8 AS golang-builder

# set the working directory
WORKDIR /app

ARG GITHUB_SHA
ARG GITHUB_REF_NAME

ENV GITHUB_REF_NAME=${GITHUB_REF_NAME}
ENV GITHUB_SHA=${GITHUB_SHA}

ARG TARGETPLATFORM

ENV CRANE_VERSION=v0.20.7
ENV OS=Linux
ENV ARCH=x86_64
ENV TRIVY_VERSION=v0.67.2
ENV COSIGN_VERSION=v2.6.1
ENV GITLEAKS_VERSION=v8.30.0

# Expected checksums for security verification
ENV CRANE_CHECKSUM=8ef3564d264e6b5ca93f7b7f5652704c4dd29d33935aff6947dd5adefd05953e
ENV TRIVY_CHECKSUM=546511a5514afc813c0b72e4abeea2c16a32228a13a1e5114d927c190e76b1f9
ENV COSIGN_CHECKSUM=064954c5d8c7e3b28188eee5b1727b31c411550bc5fefd41aa672d3c761d103a
ENV GITLEAKS_CHECKSUM=79a3ab579b53f71efd634f3aaf7e04a0fa0cf206b7ed434638d1547a2470a66e

# install crane with checksum verification
RUN curl -sL "https://github.com/google/go-containerregistry/releases/download/${CRANE_VERSION}/go-containerregistry_${OS}_${ARCH}.tar.gz" > go-containerregistry.tar.gz && \
    echo "${CRANE_CHECKSUM}  go-containerregistry.tar.gz" | sha256sum -c - && \
    tar -zxvf go-containerregistry.tar.gz -C /usr/local/bin/ crane && \
    rm go-containerregistry.tar.gz

# install trivy with checksum verification
RUN curl -sL "https://github.com/aquasecurity/trivy/releases/download/${TRIVY_VERSION}/trivy_$(echo ${TRIVY_VERSION} | sed 's/v//')_Linux-64bit.tar.gz" > trivy.tar.gz && \
    echo "${TRIVY_CHECKSUM}  trivy.tar.gz" | sha256sum -c - && \
    tar -zxvf trivy.tar.gz -C /usr/local/bin/ trivy && \
    rm trivy.tar.gz

# install cosign with checksum verification
RUN curl -sL "https://github.com/sigstore/cosign/releases/download/${COSIGN_VERSION}/cosign-linux-amd64" > cosign-linux-amd64 && \
    echo "${COSIGN_CHECKSUM}  cosign-linux-amd64" | sha256sum -c - && \
    mv cosign-linux-amd64 /usr/local/bin/cosign && \
    chmod +x /usr/local/bin/cosign

# install gitleaks with checksum verification
RUN curl -sL "https://github.com/gitleaks/gitleaks/releases/download/${GITLEAKS_VERSION}/gitleaks_$(echo ${GITLEAKS_VERSION} | sed 's/v//')_linux_x64.tar.gz" > gitleaks.tar.gz && \
    echo "${GITLEAKS_CHECKSUM}  gitleaks.tar.gz" | sha256sum -c - && \
    tar -zxvf gitleaks.tar.gz -C /usr/local/bin/ gitleaks && \
    rm gitleaks.tar.gz   

#install unzip
RUN apt-get update && apt-get install -y unzip


COPY . .

# build the scanner
RUN CGO_ENABLED=0 make devguard-scanner
# ----------------------
# create final image with node:alpine
FROM alpine:3.22.1@sha256:4bcff63911fcb4448bd4fdacec207030997caf25e9bea4045fa6c8c44de311d1

RUN apk update && apk add --no-cache git python3 dbus dbus-x11
# Create virtualenvs
ENV VENV_DIR=/opt/tools
RUN python -m venv ${VENV_DIR}/semgrep && \
    python -m venv ${VENV_DIR}/checkov

# Install semgrep in its venv
RUN ${VENV_DIR}/semgrep/bin/pip install --upgrade pip && \
    ${VENV_DIR}/semgrep/bin/pip install semgrep==1.131.0

# Install checkov in its venv
RUN ${VENV_DIR}/checkov/bin/pip install --upgrade pip && \
    ${VENV_DIR}/checkov/bin/pip install checkov==3.2.457

# Create wrapper scripts using printf to avoid heredoc issues
RUN printf '#!/bin/sh\nexec %s/semgrep/bin/semgrep "$@"\n' "${VENV_DIR}" > /usr/local/bin/semgrep && \
    chmod +x /usr/local/bin/semgrep

RUN printf '#!/bin/sh\nexec %s/checkov/bin/checkov "$@"\n' "${VENV_DIR}" > /usr/local/bin/checkov && \
    chmod +x /usr/local/bin/checkov

# add venv bin to path
ENV PATH="/usr/local/bin/venv/bin:$PATH"

COPY --from=golang-builder /usr/local/go /usr/local/go
# add go to path
ENV PATH="/usr/local/go/bin:$PATH"

COPY --from=golang-builder /app/devguard-scanner /usr/local/bin/devguard-scanner
COPY --from=golang-builder /usr/local/bin/trivy /usr/local/bin/trivy
COPY --from=golang-builder /usr/local/bin/cosign /usr/local/bin/cosign
COPY --from=golang-builder /usr/local/bin/crane /usr/local/bin/crane
COPY --from=golang-builder /usr/local/bin/gitleaks /usr/local/bin/gitleaks

ENTRYPOINT [""]